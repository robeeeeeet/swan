rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // トップレベルコレクション（アプリが使用している実際のパス）
    // ============================================================================

    // 喫煙記録コレクション
    // パス: records/{recordId}
    // recordId形式: {userId}_{timestamp}_{random}
    match /records/{recordId} {
      // 認証済みユーザーは自分のレコードのみ読み書き可能
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      // 新規作成時はリクエストデータのuserIdを確認
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
    }

    // 日次サマリーコレクション
    // パス: summaries/{summaryId}
    // summaryId形式: {userId}_{date}
    match /summaries/{summaryId} {
      // 認証済みユーザーは自分のサマリーのみ読み書き可能
      allow read, write: if request.auth != null &&
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId;
    }

    // ユーザー設定コレクション
    // パス: settings/{userId}
    match /settings/{userId} {
      // 認証済みユーザーは自分の設定のみ読み書き可能
      allow read, write: if request.auth != null &&
        request.auth.uid == userId;
    }

    // ============================================================================
    // ユーザーコレクション（サブコレクション用）
    // ============================================================================

    match /users/{userId} {
      // ユーザーは自分のプロフィールのみ読み書き可能
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Push通知トークンサブコレクション
      // パス: users/{userId}/pushTokens/{token}
      match /pushTokens/{tokenId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // レガシー: 今後使用しないが互換性のため残す
      match /records/{recordId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /summaries/{summaryId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /settings/{settingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /subscriptions/{subscriptionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /sos-sessions/{sessionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ============================================================================
    // グローバルコレクション
    // ============================================================================

    // グローバル設定コレクション（管理者のみ）
    match /global-settings/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // コーチングメッセージテンプレート（全員読み取り可能）
    match /coaching-templates/{templateId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
