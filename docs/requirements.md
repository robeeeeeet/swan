# Swan PWA 禁煙・減煙アプリ 要件定義書

## 1. プロジェクト概要

### 1.1 基本情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Swan（スワン） |
| バージョン | 1.0.0 |
| 作成日 | 2025-11-30 |

### 1.2 コンセプト

**「減らすから、やめられる」**

いきなりゼロを目指すのではなく、日々の記録とAIコーチングを通じて徐々に喫煙本数を減らし（減煙）、最終的に無理なく禁煙へと移行するアプリ。

**「先回りするAIパートナー」**

記録による現状把握だけでなく、Web Push通知を活用して「吸いたくなる瞬間」を予測・警告し、無意識の喫煙を防ぐ。

### 1.3 ターゲットユーザー

- 日本人喫煙者（禁煙・減煙希望者）
- スマートフォン（特にiPhone）ユーザー
- 過去に禁煙に失敗した経験がある人
- いきなり完全禁煙ではなく、段階的に減らしたい人

### 1.4 プラットフォーム

- PWA（Progressive Web App）
- モバイルファースト設計
- iOS Safari 16.4+ 対応（Web Push必須）
- Chrome/Edge 最新2バージョン対応

---

## 2. 技術スタック

| カテゴリ | 技術 | バージョン | 選定理由 |
|---------|------|-----------|----------|
| フロントエンド | Next.js (App Router) | 16.0.5 | React エコシステム、PWA対応が容易 |
| UI Framework | React | 19.2.0 | 最新のReactサーバーコンポーネント対応 |
| 言語 | TypeScript | 5.x | 型安全、開発効率向上 |
| スタイリング | Tailwind CSS | 4.x | 高速開発、レスポンシブ対応、PostCSS統合 |
| 状態管理 | Zustand | 5.0.8 | 軽量、シンプル |
| データベース | Firebase Firestore | 12.6.0 | リアルタイム同期、スケーラブル |
| 認証 | Firebase Auth | 12.6.0 | 匿名認証対応、ソーシャルログイン |
| Push通知 | Firebase Cloud Messaging | 12.6.0 | iOS/Android両対応 |
| AI/LLM | Gemini 2.0 Flash API | - | 高速、日本語対応 |
| ホスティング | Vercel | - | Cron Jobs、エッジ関数対応 |
| PWA | @ducanh2912/next-pwa | 10.2.9 | Workbox統合、Next.js 16対応 |

---

## 3. 機能要件

### 3.1 A群：記録・入力機能（Input）

#### A-01: 「吸った」ボタン（カウンター）

| 項目 | 内容 |
|------|------|
| 機能ID | A-01 |
| 優先度 | 必須 |
| 概要 | 今日の喫煙本数をカウントアップするボタン |

**詳細仕様:**
- 画面中央に大きく配置（タップしやすい44px以上）
- タップで即座に+1カウント
- カウント後、オプションでタグ付け画面を表示
- 判断しないニュートラルなデザイン（グレー系）
- オフライン時もローカルに記録し、オンライン復帰時に同期

**受け入れ条件:**
- [ ] ボタンタップでカウントが+1される
- [ ] カウント結果が即座に画面に反映される
- [ ] Firestoreに記録が保存される
- [ ] オフライン時でもカウントできる

---

#### A-02: 「吸いたい」ボタン（SOS / ヘルプ）

| 項目 | 内容 |
|------|------|
| 機能ID | A-02 |
| 優先度 | 必須 |
| 概要 | 吸いたくなった瞬間に押すSOSボタン |

**詳細仕様:**
- 画面中央に大きく配置（オレンジ系グラデーション）
- タップするとD群の機能（3分タイマー、深呼吸等）へ遷移
- 「魔の時間帯」通知から誘導される最初のアクション
- 衝動発生時刻を記録（分析用）

**受け入れ条件:**
- [ ] ボタンタップでSOS画面（戦略選択）に遷移
- [ ] 衝動発生時刻がFirestoreに記録される
- [ ] タップ時に視覚的フィードバックがある

---

#### A-03: 「我慢できた」ボタン（成功記録）

| 項目 | 内容 |
|------|------|
| 機能ID | A-03 |
| 優先度 | 必須 |
| 概要 | 衝動を乗り越えた後に押す成功記録ボタン |

**詳細仕様:**
- SOS画面の最後、または直接押すことも可能
- 成功時に祝福アニメーション（紙吹雪等）を表示
- 成功回数をカウントし、統計に反映
- ポジティブな色（緑系）

**受け入れ条件:**
- [ ] ボタンタップで成功記録が保存される
- [ ] 祝福アニメーションが表示される
- [ ] 統計に成功回数が反映される

---

#### A-04: 後からタグ付け

| 項目 | 内容 |
|------|------|
| 機能ID | A-04 |
| 優先度 | 高 |
| 概要 | 喫煙/我慢時の状況・理由を記録 |

**詳細仕様:**
- プリセットタグ: 起床後、食後、仕事中、休憩中、ストレス、飲酒時、その他
- 複数選択可能
- カスタムタグ追加機能（Phase 2）
- AI分析の精度向上に活用

**受け入れ条件:**
- [ ] タグ選択UIが表示される
- [ ] 選択したタグが記録に紐付けられる
- [ ] スキップ可能

---

### 3.2 B群：ダッシュボード機能（Home）

#### B-01: 本数進捗ヘッダー

| 項目 | 内容 |
|------|------|
| 機能ID | B-01 |
| 優先度 | 必須 |
| 概要 | 「今日の目標：あと〇本」を常時表示 |

**詳細仕様:**
- 画面上部に固定表示
- 今日の喫煙本数 / 目標本数を表示
- 目標達成時は祝福表示に切り替え
- 目標超過時は優しい表現（責めない）

**受け入れ条件:**
- [ ] 現在の喫煙本数が正しく表示される
- [ ] 目標本数との差分が表示される
- [ ] リアルタイムに更新される

---

#### B-02: ランダムTips

| 項目 | 内容 |
|------|------|
| 機能ID | B-02 |
| 優先度 | 中 |
| 概要 | 短い励ましテキストをランダム表示 |

**詳細仕様:**
- 「水を飲もう」「深呼吸しよう」等の短いテキスト
- 30種類以上のTipsをプリセット
- 画面更新ごとにランダム切り替え

**受け入れ条件:**
- [ ] Tipsがランダムに表示される
- [ ] 同じTipsが連続しない

---

#### B-03: 成果可視化パネル

| 項目 | 内容 |
|------|------|
| 機能ID | B-03 |
| 優先度 | 高 |
| 概要 | 節約金額と「取り戻した寿命」を表示 |

**詳細仕様:**
- 節約金額 = (基準本数 - 実際の本数) × 1本あたり価格
- 取り戻した寿命 = 吸わなかった本数 × 11分（医学的根拠に基づく）
- 累計値と今日の値を両方表示
- 節目達成時（1000円、1万円等）にお祝い通知

**受け入れ条件:**
- [ ] 節約金額が正しく計算・表示される
- [ ] 取り戻した寿命が表示される
- [ ] 数値が更新される

---

### 3.3 C群：AIコーチング機能（LLM Logic）

#### C-01: モーニング・ブリーフィング

| 項目 | 内容 |
|------|------|
| 機能ID | C-01 |
| 優先度 | 高 |
| 概要 | 毎朝指定時間にAIが通知を送る |

**詳細仕様:**
- ユーザー設定の起床時間に通知
- 昨日の成果を褒める
- 今日の目標とアドバイスを伝える
- タップするとアプリ内で詳細レポート表示

**通知例:**
> おはようございます！昨日は目標達成でしたね。今日もその調子で！

**受け入れ条件:**
- [ ] 指定時間にPush通知が届く
- [ ] 通知タップでアプリが開く
- [ ] 昨日の実績に基づいたメッセージが表示される

---

#### C-02: 魔の時間帯アラート

| 項目 | 内容 |
|------|------|
| 機能ID | C-02 |
| 優先度 | 高 |
| 概要 | 喫煙確率が高い時間の10分前に警告 |

**詳細仕様:**
- 過去の喫煙データから「魔の時間帯」を予測
- 該当時間の10分前にPush通知
- 通知タップでSOS画面へ誘導
- ユーザーごとにパーソナライズ

**通知例:**
> ⚠️ もうすぐ15時です。いつもの『仕事疲れの一本』に注意。今のうちにコーヒーを用意して！

**受け入れ条件:**
- [ ] 過去データから危険時間が予測される
- [ ] 10分前に通知が届く
- [ ] 通知内容がパーソナライズされている

---

#### C-03: ステップダウン提案

| 項目 | 内容 |
|------|------|
| 機能ID | C-03 |
| 優先度 | 中 |
| 概要 | 実績に基づき翌日の目標本数を自動調整 |

**詳細仕様:**
- 直近7日間の実績を分析
- 目標達成が続いた場合、-1本を提案
- 目標未達成が続いた場合、現状維持を提案
- ユーザーは提案を承認/拒否可能

**受け入れ条件:**
- [ ] 実績に基づいた目標が提案される
- [ ] ユーザーが提案を承認/拒否できる

---

#### C-04: 生存確認（入力忘れ防止）

| 項目 | 内容 |
|------|------|
| 機能ID | C-04 |
| 優先度 | 中 |
| 概要 | 長時間記録がない場合に優しくリマインド |

**詳細仕様:**
- 設定した時間帯（例: 18:00）に記録がない場合に通知
- 責めない優しいトーン
- 0本の場合の報告も促す

**通知例:**
> お疲れ様です。今日は0本ですか？もし吸っていたら記録をお願いします！

**受け入れ条件:**
- [ ] 記録がない場合に通知が届く
- [ ] 優しいトーンのメッセージ

---

### 3.4 D群：衝動対策・SOS機能（Support）

※ A-02「吸いたいボタン」が押された時に発動するモード群

#### D-01: 3分間画面タイマー

| 項目 | 内容 |
|------|------|
| 機能ID | D-01 |
| 優先度 | 必須 |
| 概要 | 「まずは3分だけ」カウントダウン画面 |

**詳細仕様:**
- 大きなカウントダウン表示（mm:ss）
- プログレスリングで視覚的に進捗表示
- 途中で「我慢できた」「やっぱり吸う」選択可能
- 励ましメッセージがランダムで切り替わる

**受け入れ条件:**
- [ ] 3分間のカウントダウンが正しく動作する
- [ ] 途中終了が可能
- [ ] 完了時に結果記録画面へ遷移

---

#### D-02: 深呼吸モード

| 項目 | 内容 |
|------|------|
| 機能ID | D-02 |
| 優先度 | 必須 |
| 概要 | アニメーションで呼吸を整えさせる |

**詳細仕様:**
- 呼吸サイクル: 吸う(4秒) → 止める(2秒) → 吐く(4秒) → 休止(2秒)
- 中央の円が拡大/縮小するアニメーション
- テキスト指示: 「吸って...」「止めて...」「吐いて...」
- デフォルト5サイクル（約1分）

**受け入れ条件:**
- [ ] 呼吸ガイドアニメーションが動作する
- [ ] サイクル数をカスタマイズ可能
- [ ] 途中終了が可能

---

#### D-03: AI激励/Tips

| 項目 | 内容 |
|------|------|
| 機能ID | D-03 |
| 優先度 | 高 |
| 概要 | 状況に応じた強力な励ましメッセージ |

**詳細仕様:**
- Gemini APIを使用してパーソナライズ
- 節約金額、健康効果等の具体的数値を含める
- 短く、インパクトのあるメッセージ

**メッセージ例:**
> 今やめれば520円浮きますよ！今日のランチ代になります！

**受け入れ条件:**
- [ ] 状況に応じたメッセージが生成される
- [ ] 数値が正確

---

### 3.5 E群：履歴・設定機能（History & Settings）

#### E-01: 通知設定・許可

| 項目 | 内容 |
|------|------|
| 機能ID | E-01 |
| 優先度 | 必須 |
| 概要 | 通知のON/OFF、配信時間帯の設定 |

**詳細仕様:**
- 通知許可のリクエストUI（初回起動時）
- 通知種別ごとのON/OFF設定
- 就寝時間帯（通知停止時間）の設定
- プライバシー設定（通知の詳細度）

**受け入れ条件:**
- [ ] 通知許可をリクエストできる
- [ ] 各種通知をON/OFFできる
- [ ] 設定が保存・反映される

---

#### E-02: ホーム画面追加ガイド

| 項目 | 内容 |
|------|------|
| 機能ID | E-02 |
| 優先度 | 必須 |
| 概要 | iOS向けのホーム画面追加チュートリアル |

**詳細仕様:**
- iOS Safari でのホーム画面追加手順を図解
- Web Push受信のための必須条件であることを説明
- 初回アクセス時に表示
- スキップ可能だが、設定から再表示可能

**受け入れ条件:**
- [x] iOS端末でガイドが表示される
- [x] 手順が明確に説明される
- [x] スキップ/後で見る選択が可能

---

#### E-03: カレンダー/データ保存

| 項目 | 内容 |
|------|------|
| 機能ID | E-03 |
| 優先度 | 高 |
| 概要 | 過去の履歴表示とデータ管理 |

**詳細仕様:**
- カレンダー形式で日別の喫煙本数を表示
- 日付タップで詳細（時間、タグ等）を表示
- 月間サマリー（合計、平均、目標達成率）
- データエクスポート機能（CSV）

**受け入れ条件:**
- [ ] カレンダーが表示される
- [ ] 過去のデータが閲覧できる
- [ ] 月間統計が表示される

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 指標 | 目標値 | 備考 |
|------|--------|------|
| Largest Contentful Paint (LCP) | < 2.5秒 | Core Web Vitals |
| First Input Delay (FID) | < 100ms | Core Web Vitals |
| Cumulative Layout Shift (CLS) | < 0.1 | Core Web Vitals |
| Time to Interactive (TTI) | < 3.5秒 | |
| First Contentful Paint (FCP) | < 1.8秒 | |

### 4.2 オフライン対応

| 機能 | オフライン時の動作 |
|------|-------------------|
| 記録（吸った/我慢） | IndexedDBに保存、オンライン復帰時に同期 |
| ダッシュボード表示 | キャッシュされた最新データを表示 |
| SOS機能 | 完全動作（タイマー、深呼吸） |
| 履歴表示 | キャッシュされたデータを表示 |
| Push通知 | 受信不可（オンライン時のみ） |

### 4.3 セキュリティ

| 項目 | 対策 |
|------|------|
| データ暗号化 | Firestore暗号化、HTTPS通信 |
| 認証 | Firebase Auth、セッション管理 |
| 個人情報 | 最小限の収集、匿名認証対応 |
| XSS対策 | React自動エスケープ、CSP設定 |
| CSRF対策 | SameSite Cookie、トークン検証 |

### 4.4 アクセシビリティ

| 項目 | 対応 |
|------|------|
| 準拠レベル | WCAG 2.1 Level AA |
| キーボード操作 | 全機能操作可能 |
| スクリーンリーダー | ARIA対応 |
| 色覚多様性 | コントラスト比4.5:1以上 |
| タッチターゲット | 最小44px×44px |

### 4.5 対応環境

| 環境 | バージョン |
|------|-----------|
| iOS Safari | 16.4以上（Web Push対応） |
| Chrome | 最新2バージョン |
| Edge | 最新2バージョン |
| Firefox | 最新2バージョン |
| Android Chrome | 最新2バージョン |

---

## 5. ユーザーストーリー

### 5.1 朝のシナリオ

```
1. ユーザーは起床後、Push通知を受信
   「おはようございます！昨日は目標達成でしたね」
2. 通知タップでアプリを開く
3. 今日の目標を確認
4. モーニングTipsを読んで1日のモチベーションを高める
```

### 5.2 日中のシナリオ（魔の時間帯）

```
1. 14:50にPush通知を受信
   「もうすぐ魔の15時です。深呼吸の準備を」
2. 通知タップでアプリを開く
3. 「吸いたい」ボタンをタップ → SOS画面へ
4. 「深呼吸」を選択 → 呼吸ガイドを実行
5. 衝動が収まる
6. 「我慢できた」ボタンをタップ → 祝福アニメーション
```

### 5.3 吸ってしまった場合のシナリオ

```
1. アプリを開く
2. 「吸った」ボタンをタップ
3. カウントが+1される
4. 状況タグ（例：仕事ストレス）を選択
5. 記録完了（判断のないニュートラルなUI）
```

---

## 6. 画面構成

### 6.1 メイン画面構成

```
┌─────────────────────────────┐
│  [本数進捗ヘッダー] B-01     │
│  今日の目標：あと 5 本      │
├─────────────────────────────┤
│                             │
│  [ランダムTips] B-02        │
│  「水を飲んでリフレッシュ」  │
│                             │
│  ┌─────────┐ ┌─────────┐    │
│  │ 吸いたい │ │  吸った  │    │
│  │  (SOS)  │ │ (Count) │    │
│  │  A-02   │ │  A-01   │    │
│  └─────────┘ └─────────┘    │
│                             │
│  [成果可視化パネル] B-03     │
│  節約: ¥1,520 | 寿命: +3時間 │
│                             │
├─────────────────────────────┤
│ [ホーム] [履歴] [設定]      │
└─────────────────────────────┘
```

### 6.2 画面一覧

| 画面名 | パス | 概要 |
|--------|------|------|
| ダッシュボード | / | メイン画面 |
| SOS選択 | /sos | 戦略選択画面 |
| タイマー | /sos/timer | 3分タイマー |
| 深呼吸 | /sos/breathing | 呼吸ガイド |
| 履歴 | /history | カレンダー/履歴 |
| 設定 | /settings | 各種設定 |
| オンボーディング | /onboarding | 初回設定 |

---

## 7. 用語定義

| 用語 | 定義 |
|------|------|
| 減煙 | 喫煙本数を段階的に減らすこと |
| 禁煙 | 喫煙を完全にやめること |
| 魔の時間帯 | 喫煙確率が高い時間帯 |
| SOS | 衝動が発生した際の緊急対応モード |
| 衝動 | タバコを吸いたいという欲求 |
| 我慢 | 衝動を乗り越えて喫煙しないこと |

---

## 8. 前提条件・制約

### 8.1 前提条件

- ユーザーはスマートフォンを所有している
- インターネット接続環境がある（Push通知受信時）
- ユーザーは禁煙/減煙の意思がある

### 8.2 制約

- iOS Safari 16.4未満ではPush通知が利用不可
- オフライン時はPush通知を受信できない
- Gemini API利用にはAPI費用が発生

---

## 9. 改訂履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-11-30 | 初版作成 |
